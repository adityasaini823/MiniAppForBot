<!DOCTYPE html>
<html>
<head>
  <title>Secure Link Redirect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  Redirecting....
  <h2 id="error"></h2>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const webApp = window.Telegram.WebApp;
      webApp.ready();
      webApp.expand();
      
      const user = Telegram.WebApp.initDataUnsafe.user;
      const startParam = webApp.initDataUnsafe.start_param;
      const uuid = startParam;

      // Request payload (body data)
      const postData = {
        uuid: uuid,
        id: user.id,
        first_name: user.first_name,
        last_name: user.last_name || '',
        username: user.username || '',
        language_code: user.language_code || ''
      };

      try {
        // Send POST request with JSON body
        const response = await axios.post(
          'https://urlencrypterbot.onrender.com/api/resolve',
          postData,
          {
            headers: {
              'Content-Type': 'application/json'
            }
          }
        );

        if (response.data) {
          webApp.openTelegramLink(response.data.originalLink);
          webApp.close();
        }
      } catch (err) {
        alert("Failed to redirect. Please try again later.");
        console.error('API Error:', err);
      }
    });
  </script>
</body>
</html>