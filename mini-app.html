<!DOCTYPE html>
<html>
<head>
  <title>Secure Link Redirect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <h2 id="error"></h2>
  <div id="responseData"></div>

  <script>
     const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    document.addEventListener("DOMContentLoaded", async () => {
      const webApp = window.Telegram.WebApp;
      webApp.ready();

      // Check if Telegram data is available
      if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
        document.getElementById("error").innerText = "Telegram data not available.";
        console.error("Telegram data not available.");
        return;
      }
      
      const user = Telegram.WebApp.initDataUnsafe.user;
      const startParam = webApp.initDataUnsafe.start_param;
      const uuid = startParam; // Using start_param as uuid

      // Create payload object
      const postData = {
        uuid: uuid,
        id: user.id,
        first_name: user.first_name,
        last_name: user.last_name || '',
        username: user.username || '',
      };

      // Debugging: Log the request payload
      console.log("Post Data Payload:", postData);

      try {
        // Send POST request with JSON body
        const response = await axios.post(
          'https://urlencrypterbot-production.up.railway.app/api/resolve',
          postData,
          {
            headers: {
              'Content-Type': 'application/json'
            }
          }
        );

        // Debugging: Log the full server response
        console.log("Server Response:", response);

        if (response.data) {
          const { originalLink, createdAt, user } = response.data;

          // Display the data on the page
          const responseDataDiv = document.getElementById('responseData');
          responseDataDiv.innerHTML = `
            <p><strong>Original Link:</strong> ${originalLink}</p>
            <p><strong>Created At:</strong> ${new Date(createdAt).toLocaleString()}</p>
            <p><strong>User Info:</strong> 
              ${user ? `${user.firstName} ${user.lastName} (@${user.username})` : "No user info"}
            </p>
          `;

          console.log("Original Link:", originalLink);

          // Redirect if originalLink is valid
          if (originalLink) {
            if (/android/i.test(userAgent)) {
              window.location.href = originalLink;
            }
            webApp.openTelegramLink(originalLink);
            webApp.close();
          }
        } else {
          document.getElementById("error").innerText = "Invalid response from server.";
          console.warn("Invalid response from server:", response.data);
        }
      } catch (err) {
        document.getElementById("error").innerText = "Failed to redirect. Please try again later.";
        console.error("Error during request:", err);
      }
    });
  </script>
</body>
</html>
