<!DOCTYPE html>
<html>
<head>
  <title>Secure Link Redirect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  Redirecting....
  <h2 id="error"></h2>
  <script>
    const API_URL = "https://urlencrypterbot.onrender.com";
    const tg = window.Telegram.WebApp;
    tg.ready();
    async function redirect() {
      const urlParams = new URLSearchParams(window.location.search);
      const uuid = urlParams.get('uuid');
      if (!uuid) {
         console.log("uuid");
        alert('Invalid request: Missing UUID.');
        return;
      }
      try {
        const response = await fetch(`${API_URL}/api/resolve?uuid=${uuid}`);
        const data = await response.json();
        const channelUsername = data.originalLink.replace("https://t.me/", "").replace("@", "").trim();
        const telegramDeepLink = `tg://resolve?domain=${channelUsername}`;
        const telegramWebLink = `https://t.me/${channelUsername}`;
        if (channelUsername) {
          setTimeout(() => {
            // First try the Telegram deep link
            tg.openLink(telegramDeepLink);

            // If deep link fails, use the web link
            setTimeout(() => {
              tg.openLink(telegramWebLink);
            }, 1000);
          }, 100);
          tg.close();
        } else {
          document.getElementById('redirection failed');
           console.log('Invalid or expired link');
          alert('Invalid or expired link');
        }
      } catch (error) {
        console.log(error);
        alert('Error processing your request');
      }
    }
    redirect();
  </script>
</body>
</html>
